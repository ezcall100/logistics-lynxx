# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yaml-language-server: disableContextAccess: true
# yaml-language-server: disableDefaultProperties: true
# yaml-language-server: disableAdditionalProperties: true
# yaml-language-server: validate: false
# yaml-language-server: disableSchemaValidation: true

# Autonomous TMS: test â†’ build â†’ deploy â†’ monitor
name: ğŸš€ Autonomous Deploy

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: "true"
  NPM_CONFIG_FUND: "false"
  NPM_CONFIG_AUDIT: "false"

defaults:
  run:
    shell: bash

# 1) Normalize and expose config as job outputs once
jobs:
  config:
    name: ğŸ”§ Resolve Config
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.cfg.outputs.env_name }}
      app_url: ${{ steps.cfg.outputs.app_url }}
      n8n_enabled: ${{ steps.cfg.outputs.n8n_enabled }}
      n8n_base_url: ${{ steps.cfg.outputs.n8n_base_url }}
    steps:
      - id: cfg
        run: |
          set -euo pipefail
          ENV_NAME="${{ vars.ENVIRONMENT_NAME || 'production' }}"
          APP_URL="${{ vars.APP_URL || 'https://app.example.com' }}"
          N8N_ENABLED_IN="${{ vars.N8N_ENABLED || 'false' }}"
          N8N_BASE_URL="${{ vars.N8N_BASE_URL || '' }}"
          # normalize boolean-ish values
          case "${N8N_ENABLED_IN,,}" in true|1|yes|y) N8N_ENABLED=true ;; *) N8N_ENABLED=false ;; esac
          {
            echo "env_name=$ENV_NAME"
            echo "app_url=$APP_URL"
            echo "n8n_enabled=$N8N_ENABLED"
            echo "n8n_base_url=$N8N_BASE_URL"
          } >> "$GITHUB_OUTPUT"

  # 2) Test & build once, upload artifact
  test:
    name: ğŸ§ª Test & ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: config
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Install
        run: npm ci

      - name: ğŸ” Lint
        run: npm run lint

      - name: ğŸ§ª Test
        run: npm run test --if-present

      - name: ğŸ—ï¸ Build
        run: npm run build

      - name: ğŸ“¦ Package build artifact
        run: |
          mkdir -p .artifact
          tar -czf .artifact/build.tar.gz dist/ package*.json node_modules/
      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: .artifact/build.tar.gz
          retention-days: 1

  # 3) Deploy from artifact, health-check, optional n8n trigger + webhook
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [config, test]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 20
    environment:
      name: ${{ needs.config.outputs.env_name }}
      url: ${{ needs.config.outputs.app_url }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Load secrets & validate
        id: secrets
        run: |
          set -euo pipefail
          # map secrets (fallbacks only for local safety)
          SUPABASE_URL="${{ secrets.SUPABASE_URL || 'https://placeholder.supabase.co' }}"
          SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY || 'placeholder-key' }}"
          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY || 'placeholder-key' }}"
          N8N_API_KEY="${{ secrets.N8N_API_KEY || '' }}"
          N8N_BASE_URL="${{ needs.config.outputs.n8n_base_url }}"
          # mask sensitive
          echo "::add-mask::$OPENAI_API_KEY"
          echo "::add-mask::$N8N_API_KEY"
          # hard-validate required deployment secrets
          [[ -n "$SUPABASE_URL" ]] || { echo "âŒ SUPABASE_URL missing"; exit 1; }
          [[ -n "$SUPABASE_ANON_KEY" ]] || { echo "âŒ SUPABASE_ANON_KEY missing"; exit 1; }
          [[ -n "$OPENAI_API_KEY" ]] || { echo "âŒ OPENAI_API_KEY missing"; exit 1; }
          # export for later steps
          {
            echo "SUPABASE_URL=$SUPABASE_URL"
            echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY"
            echo "OPENAI_API_KEY=$OPENAI_API_KEY"
            echo "N8N_API_KEY=$N8N_API_KEY"
            echo "N8N_BASE_URL=$N8N_BASE_URL"
          } >> "$GITHUB_ENV"

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm
          cache-dependency-path: package-lock.json

      - name: â¬‡ï¸ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: .artifact

      - name: ğŸ“¦ Expand artifact
        run: tar -xzf .artifact/build.tar.gz

      - name: ğŸš€ Deploy app
        run: |
          # Replace with your real deploy command/script
          npm run deploy:prod

      - name: ğŸ¥ Health check
        run: npm run health:check

      - name: ğŸ”” Build payload (success)
        id: hook_ok
        if: ${{ success() && (vars.DEPLOYMENT_WEBHOOK_URL != '') }}
        run: |
          ts="$(date -u +%FT%TZ)"
          cat <<JSON >> "$GITHUB_OUTPUT"
          payload<<EOF
          {"status":"deployed","timestamp":"$ts","environment":"${{ needs.config.outputs.env_name }}","commit":"${{ github.sha }}","branch":"${{ github.ref_name }}","run_id":"${{ github.run_id }}"}
          EOF
          JSON

      - name: ğŸ”” Notify webhook (success)
        if: ${{ success() && (vars.DEPLOYMENT_WEBHOOK_URL != '') }}
        run: |
          for i in 1 2 3; do
            curl -fsS -X POST "${{ vars.DEPLOYMENT_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '${{ steps.hook_ok.outputs.payload }}' && break
            echo "retry $i/3â€¦"; sleep 5
          done

      - name: ğŸ”” Build payload (failure)
        id: hook_fail
        if: ${{ failure() && (vars.DEPLOYMENT_WEBHOOK_URL != '') }}
        run: |
          ts="$(date -u +%FT%TZ)"
          cat <<JSON >> "$GITHUB_OUTPUT"
          payload<<EOF
          {"status":"failed","timestamp":"$ts","environment":"${{ needs.config.outputs.env_name }}","commit":"${{ github.sha }}","branch":"${{ github.ref_name }}","run_id":"${{ github.run_id }}"}
          EOF
          JSON

      - name: ğŸ”” Notify webhook (failure)
        if: ${{ failure() && (vars.DEPLOYMENT_WEBHOOK_URL != '') }}
        run: |
          for i in 1 2 3; do
            curl -fsS -X POST "${{ vars.DEPLOYMENT_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '${{ steps.hook_fail.outputs.payload }}' && break
            echo "retry $i/3â€¦"; sleep 5
          done

      - name: ğŸ§¾ Summary
        if: always()
        run: |
          {
            echo "## Deploy Summary"
            echo "- Status: ${{ job.status }}"
            echo "- Env: ${{ needs.config.outputs.env_name }}"
            echo "- URL: ${{ needs.config.outputs.app_url }}"
            echo "- Run: ${{ github.run_id }}"
            echo "- SHA: ${{ github.sha }}"
            echo "- Branch: ${{ github.ref_name }}"
          } >> "$GITHUB_STEP_SUMMARY"

  # 4) Optional monitoring after deploy
  monitor:
    name: ğŸ“ˆ Monitor
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Install
        run: npm ci

      - name: â–¶ï¸ Start monitoring
        run: npm run monitor:start

      - name: â±ï¸ Observe for 5 minutes
        run: sleep 300

      - name: ğŸ¥ Final health
        run: npm run health:check

      - name: ğŸ§¾ Monitoring summary
        if: always()
        run: |
          echo "## Monitoring" >> "$GITHUB_STEP_SUMMARY"
          echo "- Status: ${{ job.status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Health check executed" >> "$GITHUB_STEP_SUMMARY"
