# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: ğŸ” Network Diagnostic

on:
  workflow_dispatch:
  push:
    branches: [main, develop]

permissions:
  contents: read

jobs:
  network-test:
    name: ğŸ” Network Connectivity Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ” Test Basic Connectivity
        run: |
          echo "ğŸ” Testing basic network connectivity..."
          
          # Test DNS resolution
          echo "ğŸ“¡ Testing DNS resolution..."
          nslookup github.com || echo "âŒ DNS resolution failed"
          nslookup api.github.com || echo "âŒ API DNS resolution failed"
          
          # Test basic connectivity
          echo "ğŸŒ Testing basic connectivity..."
          ping -c 3 github.com || echo "âŒ Ping failed"
          
          # Test HTTPS connectivity
          echo "ğŸ”’ Testing HTTPS connectivity..."
          curl -I https://github.com || echo "âŒ HTTPS connection failed"
          curl -I https://api.github.com || echo "âŒ API HTTPS connection failed"
          
          echo "âœ… Basic connectivity tests completed"
      
      - name: ğŸ” Test Git Operations
        run: |
          echo "ğŸ” Testing Git operations..."
          
          # Test git config
          git config --global user.name "test"
          git config --global user.email "test@example.com"
          
          # Test git clone (shallow)
          echo "ğŸ“¥ Testing git clone..."
          git clone --depth 1 https://github.com/actions/checkout.git /tmp/test-repo || echo "âŒ Git clone failed"
          
          # Test git fetch
          echo "ğŸ“¡ Testing git fetch..."
          cd /tmp/test-repo
          git fetch --depth 1 || echo "âŒ Git fetch failed"
          
          echo "âœ… Git operation tests completed"
      
      - name: ğŸ” Test StepSecurity Permissions
        run: |
          echo "ğŸ” Testing StepSecurity network permissions..."
          
          # Test with StepSecurity enabled
          echo "ğŸ›¡ï¸ Testing with StepSecurity..."
          
          # Test allowed endpoints
          curl -I https://github.com || echo "âŒ GitHub.com access failed"
          curl -I https://api.github.com || echo "âŒ API access failed"
          curl -I https://raw.githubusercontent.com || echo "âŒ Raw content access failed"
          
          echo "âœ… StepSecurity permission tests completed"
      
      - name: ğŸ” Environment Information
        run: |
          echo "ğŸ” Collecting environment information..."
          
          echo "ğŸŒ Environment variables:"
          env | grep -E "(GITHUB|RUNNER|ACTIONS)" || echo "No relevant env vars found"
          
          echo "ğŸ”§ Git configuration:"
          git config --list || echo "Git config failed"
          
          echo "ğŸŒ Network interfaces:"
          ip addr show || echo "Network interface check failed"
          
          echo "ğŸ“¡ DNS configuration:"
          cat /etc/resolv.conf || echo "DNS config check failed"
      
      - name: ğŸ“Š Diagnostic Summary
        run: |
          echo "## ğŸ” Network Diagnostic Summary"
          echo ""
          echo "**Runner:** ${{ runner.os }}"
          echo "**Environment:** ${{ runner.environment }}"
          echo "**Repository:** ${{ github.repository }}"
          echo "**Event:** ${{ github.event_name }}"
          echo ""
          echo "### ğŸ”§ Troubleshooting Steps:"
          echo "1. Check GitHub Status: https://www.githubstatus.com/"
          echo "2. Verify repository permissions"
          echo "3. Check network firewall settings"
          echo "4. Try different runner type if available"
          echo ""
          echo "### ğŸ› ï¸ Next Actions:"
          echo "- If tests pass: Network is working correctly"
          echo "- If tests fail: Check GitHub status and network configuration"
          echo "- For persistent issues: Contact GitHub support"
