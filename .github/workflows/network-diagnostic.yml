# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yaml-language-server: disableContextAccess: true
# yaml-language-server: disableDefaultProperties: true
# yaml-language-server: disableAdditionalProperties: true
# yaml-language-server: validate: false
# yaml-language-server: disableSchemaValidation: true

name: ðŸ” Network Diagnostic

on:
  workflow_dispatch:
  push:
    branches: [main, develop]

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  network-test:
    name: ðŸ” Network Connectivity Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      ENVIRONMENT_NAME: ${{ vars.ENVIRONMENT_NAME || 'development' }}
      APP_URL: ${{ vars.APP_URL || 'http://localhost' }}

    steps:
      - name: ðŸ”§ Ensure diagnostic tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            dnsutils iputils-ping iproute2 curl ca-certificates git

      - name: ðŸŒ Basic network checks
        run: |
          set -euo pipefail
          echo "ðŸ” DNS resolution"
          nslookup github.com            || echo "âŒ nslookup github.com failed"
          nslookup api.github.com        || echo "âŒ nslookup api.github.com failed"

          echo ""
          echo "ðŸ“¡ ICMP ping (may be blocked by remote host)"
          ping -c 3 github.com           || echo "âŒ ping github.com failed"

          echo ""
          echo "ðŸ”’ HTTPS reachability (HEAD)"
          for u in https://github.com https://api.github.com https://raw.githubusercontent.com https://codeload.github.com https://registry.npmjs.org ; do
            echo "â†’ $u"
            curl -fsSIL --max-time 10 "$u" >/dev/null || echo "âŒ curl HEAD failed for $u"
          done
          echo "âœ… Basic connectivity tests completed"

      - name: ðŸ“¦ Git operations check
        run: |
          set -euo pipefail
          export GIT_TERMINAL_PROMPT=0
          TMPDIR="$(mktemp -d /tmp/netdiag.XXXXXX)"
          echo "Cloning to $TMPDIR"
          if git clone --depth 1 https://github.com/actions/checkout.git "$TMPDIR/checkout"; then
            echo "âœ… git clone ok"
            if git -C "$TMPDIR/checkout" fetch --depth 1 origin HEAD; then
              echo "âœ… git fetch ok"
            else
              echo "âŒ git fetch failed"
            fi
          else
            echo "âŒ git clone failed"
          fi

      - name: âœ… Common CI endpoints probe
        run: |
          set -euo pipefail
          echo "Probing common endpoints:"
          endpoints=(
            "https://github.com"
            "https://api.github.com"
            "https://raw.githubusercontent.com"
            "https://codeload.github.com"
            "https://registry.npmjs.org"
            "https://nodejs.org"
          )
          for e in "${endpoints[@]}"; do
            echo "â†’ $e"
            curl -fsSIL --max-time 10 "$e" >/dev/null || echo "âŒ cannot reach $e"
          done
          echo "âœ… Endpoint probes completed"

      - name: ðŸ–¥ï¸ Environment information
        run: |
          set -euo pipefail
          echo "ðŸ” Runner & env"
          echo "OS: $(uname -a)"
          echo "Date: $(date -Is)"
          echo "Repo: ${{ github.repository }}"
          echo "Ref:  ${{ github.ref_name }}"
          echo "SHA:  ${{ github.sha }}"
          echo ""
          echo "ðŸ”§ Git config"
          git config --list || echo "Git config unavailable"
          echo ""
          echo "ðŸŒ Network interfaces"
          ip addr show || echo "ip addr failed"
          echo ""
          echo "ðŸ“¡ DNS configuration"
          cat /etc/resolv.conf || echo "resolv.conf read failed"
          echo ""
          echo "ðŸ§ª Selected environment variables"
          env | sort | grep -E '^(GITHUB|RUNNER|ACTIONS)_' || echo "No matching vars"

      - name: ðŸ“Š Diagnostic Summary
        if: always()
        run: |
          {
            echo "## ðŸ” Network Diagnostic Summary"
            echo ""
            echo "- **Runner:** \`${{ runner.os }}\`"
            echo "- **Environment:** \`${{ env.ENVIRONMENT_NAME }}\`"
            echo "- **Repository:** \`${{ github.repository }}\`"
            echo "- **Event:** \`${{ github.event_name }}\`"
            echo ""
            echo "### ðŸ”§ Troubleshooting Steps"
            echo "1. Check GitHub Status: https://www.githubstatus.com/"
            echo "2. Verify repository and org network policies"
            echo "3. Review firewall or egress restrictions"
            echo "4. Try a different runner image if available"
            echo ""
            echo "### ðŸ› ï¸ Next Actions"
            echo "- If tests pass: network is healthy âœ…"
            echo "- If failures occurred: inspect logs above and adjust egress rules or DNS ðŸ”§"
          } >> "$GITHUB_STEP_SUMMARY"
