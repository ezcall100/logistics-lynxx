# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: üöÄ Autonomous CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy to environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      rollback:
        description: "Rollback to previous release?"
        required: false
        default: false
        type: boolean

# Prevent overlapping deploys
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Global bash hardening
defaults:
  run:
    shell: bash

# Least-privilege permissions
permissions:
  contents: read
  deployments: write
  id-token: write
  security-events: write
  actions: read

env:
  NODE_VERSION: '18'
  # ---- URLs & Webhooks ----
  STAGING_URL: ""
  PRODUCTION_URL: ""
  STAGING_WEBHOOK_URL: ""
  PRODUCTION_WEBHOOK_URL: ""
  STAGING_HEALTH_CHECK_URL: ""
  PRODUCTION_HEALTH_CHECK_URL: ""
  DEPLOYMENT_WEBHOOK_URL: ""

  # ---- App / Env Vars ----
  ENVIRONMENT_NAME: ${{ vars.ENVIRONMENT_NAME || 'development' }}
  APP_URL: "http://localhost"
  N8N_ENABLED: "false"
  N8N_BASE_URL: ""

  # ---- API / Keys ----
  N8N_API_KEY: ""
  SUPABASE_URL: ""
  SUPABASE_ANON_KEY: ""
  OPENAI_API_KEY: ""
  
  # ---- n8n Webhook Configuration ----
  N8N_WEBHOOK_URL: ""
  N8N_WEBHOOK_SECRET: ""

jobs:
  # üõ°Ô∏è Guard Secrets & Variables
  guard-secrets:
    name: üõ°Ô∏è Validate Required Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Validate required secrets
        shell: bash
        env:
          REQUIRED: STAGING_URL,PRODUCTION_URL,STAGING_WEBHOOK_URL,PRODUCTION_WEBHOOK_URL,STAGING_HEALTH_CHECK_URL,PRODUCTION_HEALTH_CHECK_URL,DEPLOYMENT_WEBHOOK_URL,N8N_API_KEY,SUPABASE_URL,SUPABASE_ANON_KEY,OPENAI_API_KEY
        run: |
          set -euo pipefail
          missing=()
          IFS=',' read -ra keys <<< "$REQUIRED"
          for k in "${keys[@]}"; do
            v="${!k-}"          # safe expansion if unset
            if [ -z "$v" ]; then
              missing+=("$k")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error title=Missing secrets::${missing[*]} not set in repo/org/environment secrets."
            exit 1
          fi
          echo "All required secrets present."

  # üîç Lint Workflows
  lint-workflows:
    name: üîç Lint Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Lint workflows with actionlint
        run: |
          echo "üîç Installing and running actionlint..."
          curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash | bash
          ./actionlint -shellcheck= -pyflakes=  # disable extras if not installed
          echo "‚úÖ Workflow linting passed!"

  # üîç Pre-flight Checks
  preflight:
    name: üîç Pre-flight Validation
    runs-on: ubuntu-latest
    needs: [guard-secrets, lint-workflows]
    timeout-minutes: 5
    outputs:
      should_deploy: ${{ steps.decider.outputs.should_deploy }}
      target_environment: ${{ steps.decider.outputs.target_environment }}
    
    steps:
      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîç Validate environment
        id: decider
        run: |
           # Determine if we should deploy based on trigger
           if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
             echo "should_deploy=true" >> "$GITHUB_OUTPUT"
             echo "target_environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
           elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
             echo "should_deploy=true" >> "$GITHUB_OUTPUT"
             echo "target_environment=production" >> "$GITHUB_OUTPUT"
           elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/develop" ]]; then
             echo "should_deploy=true" >> "$GITHUB_OUTPUT"
             echo "target_environment=staging" >> "$GITHUB_OUTPUT"
           else
             echo "should_deploy=false" >> "$GITHUB_OUTPUT"
             echo "target_environment=none" >> "$GITHUB_OUTPUT"
           fi
           
           echo "üöÄ Deployment decision completed"

      - name: üßæ Display deployment decision
        run: |
           echo "should_deploy=${{ steps.decider.outputs.should_deploy || 'false' }}"
           echo "target_environment=${{ steps.decider.outputs.target_environment || 'n/a' }}"
           {
             echo "## üöÄ Deployment Plan"
             echo "- Should deploy: \`${{ steps.decider.outputs.should_deploy || 'false' }}\`"
             echo "- Target environment: \`${{ steps.decider.outputs.target_environment || 'n/a' }}\`"
             echo "- Trigger: \`${{ github.event_name }}\`"
             echo "- Branch: \`${{ github.ref_name }}\`"
           } >> "$GITHUB_STEP_SUMMARY"

  # üß™ Quality Assurance
  quality-assurance:
    name: üß™ Quality Assurance
    runs-on: ubuntu-latest
    needs: preflight
    timeout-minutes: 15
    
    steps:
      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: |
          npm ci
          cd logistics-lynx && npm ci
      
      - name: üîç Run ESLint
        run: |
          npx eslint . --ext ts,tsx --max-warnings 0
          cd logistics-lynx && npx eslint . --ext ts,tsx --max-warnings 0
      
      - name: üîß TypeScript check
        run: |
          npx tsc --noEmit
          cd logistics-lynx && npx tsc --noEmit
      
      - name: üß™ Run tests
        run: |
          if npm run test; then
            echo "‚úÖ Tests passed"
          else
            echo "‚ö†Ô∏è No tests found or tests failed"
          fi
      
      - name: üîí Security audit
        run: |
          npm audit --audit-level moderate || true
          cd logistics-lynx && npm audit --audit-level moderate || true
      
      - name: üîç Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT,Apache-2.0,ISC,BSD-2-Clause,BSD-3-Clause

  # üèóÔ∏è Build & Package
  build:
    name: üèóÔ∏è Build & Package
    runs-on: ubuntu-latest
    needs: [preflight, quality-assurance]
    if: needs.preflight.outputs.should_deploy == 'true'
    timeout-minutes: 20
    
    steps:
      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: |
          npm ci
          cd logistics-lynx && npm ci
      
      - name: üèóÔ∏è Build application
        run: |
          cd logistics-lynx
          npm run build
      
      - name: üì¶ Package artifacts
        run: |
          # Create deployment package
          mkdir -p deployment/artifacts
          cp -r logistics-lynx/dist/* deployment/artifacts/
          cp -r logistics-lynx/public deployment/artifacts/
          cp logistics-lynx/package.json deployment/artifacts/
          
          # Include autonomous system files
          cp 24-7-autonomous-system.cjs deployment/artifacts/
          cp agent-boot.js deployment/artifacts/
          cp test-n8n-webhook-cursor.js deployment/artifacts/
      
      - name: üì§ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: deployment/artifacts/
          retention-days: ${{ needs.preflight.outputs.target_environment == 'production' && 30 || 7 }}

  # üöÄ Autonomous Deployment
  deploy:
    name: üöÄ Autonomous Deployment
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: needs.preflight.outputs.should_deploy == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)
    timeout-minutes: 30
    permissions:
      contents: write
      deployments: write
    environment:
      name: ${{ needs.preflight.outputs.target_environment }}
      url: ${{ needs.preflight.outputs.target_environment == 'staging' && env.STAGING_URL || env.PRODUCTION_URL }}
    env:
      N8N_WEBHOOK_URL: ""
      N8N_WEBHOOK_SECRET: ""
    
    steps:
      - name: Guard optional secrets (warn only)
        shell: bash
        run: |
          echo "::warning::n8n webhook secrets not available in environment-protected job"
          echo "::warning::n8n webhook notifications will be skipped"

      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üì• Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts
          path: deployment/artifacts/
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: üì¶ Install deployment dependencies
        run: npm ci

      - name: üöÄ Run autonomous deployment
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          if [[ "${{ github.event.inputs.rollback }}" == "true" ]]; then
            echo "üîÑ Rolling back to previous release..."
            node deployment/autonomous-deployment-system.js --rollback ${{ needs.preflight.outputs.target_environment }}
          else
            echo "üöÄ Deploying to ${{ needs.preflight.outputs.target_environment }}..."
            node deployment/autonomous-deployment-system.js ${{ needs.preflight.outputs.target_environment }}
          fi
        env:
          # Database configuration
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          
          # Environment URLs
          STAGING_URL: ${{ env.STAGING_URL }}
          PRODUCTION_URL: ${{ env.PRODUCTION_URL }}
          
          # Webhook URLs
          STAGING_WEBHOOK_URL: ${{ env.STAGING_WEBHOOK_URL }}
          PRODUCTION_WEBHOOK_URL: ${{ env.PRODUCTION_WEBHOOK_URL }}
          STAGING_HEALTH_CHECK_URL: ${{ env.STAGING_HEALTH_CHECK_URL }}
          PRODUCTION_HEALTH_CHECK_URL: ${{ env.PRODUCTION_HEALTH_CHECK_URL }}

      - name: üè• Post-deploy smoke check
        if: ${{ needs.preflight.outputs.should_deploy == 'true' && github.event.inputs.rollback != 'true' }}
        timeout-minutes: 1
        env:
          HEALTH_URL: ${{ needs.preflight.outputs.target_environment == 'production' && env.PRODUCTION_HEALTH_CHECK_URL || env.STAGING_HEALTH_CHECK_URL }}
        run: |
          set -euo pipefail
          if [[ -n "$HEALTH_URL" ]]; then
            echo "üîç Checking: $HEALTH_URL"
            curl -fsSL "$HEALTH_URL"
            echo "‚úÖ Smoke check passed"
          else
            echo "‚ö†Ô∏è No health check URL configured, skipping smoke check"
          fi

      - name: üì§ Upload deployment logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs-${{ github.run_id }}
          path: deployment/logs/**
          retention-days: 7

  # üì£ n8n Webhook Notifications (separate job to avoid environment restrictions)
  n8n-notifications:
    name: üì£ n8n Webhook Notifications
    runs-on: ubuntu-latest
    needs: [preflight, deploy, health-check]
    if: always() && needs.preflight.outputs.should_deploy == 'true'
    timeout-minutes: 10
    env:
      N8N_WEBHOOK_URL: ""
      N8N_WEBHOOK_SECRET: ""
    
    steps:
      - name: Resolve optional n8n secrets
        shell: bash
        run: |
          echo "N8N_WEBHOOK_URL=${{ secrets.N8N_WEBHOOK_URL }}" >> "$GITHUB_ENV"
          echo "N8N_WEBHOOK_SECRET=${{ secrets.N8N_WEBHOOK_SECRET }}" >> "$GITHUB_ENV"

      - name: üì£ Notify n8n webhook (deployment)
        if: ${{ always() && env.N8N_WEBHOOK_URL != '' && env.N8N_WEBHOOK_SECRET != '' }}
        run: |
          set -euo pipefail
          
          ts="$(date -u +%FT%TZ)"
          idem="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          # Build JSON (no jq dependency)
          cat > payload.json <<JSON
          {
            "event": "deployment",
            "status": "${{ needs.deploy.result }}",
            "repo": "${{ github.repository }}",
            "sha": "${{ github.sha }}",
            "ref": "${{ github.ref_name }}",
            "run_id": "${{ github.run_id }}",
            "run_attempt": "${{ github.run_attempt }}",
            "environment": "${{ needs.preflight.outputs.target_environment }}",
            "app_url": "${{ env.APP_URL }}",
            "should_deploy": "${{ needs.preflight.outputs.should_deploy || 'false' }}",
            "target_environment": "${{ needs.preflight.outputs.target_environment || 'n/a' }}",
            "timestamp": "${ts}"
          }
          JSON

          # Sign payload (HMAC-SHA256, base64)
          sig="$(openssl dgst -sha256 -hmac "$N8N_WEBHOOK_SECRET" -binary payload.json | base64)"

          # Fire webhook (robust retries)
          curl -fsS --retry 5 --retry-all-errors --max-time 20 \
            -H "Content-Type: application/json" \
            -H "X-Idempotency-Key: ${idem}" \
            -H "X-Signature-256: sha256=${sig}" \
            --data-binary @payload.json \
            "$N8N_WEBHOOK_URL"

      - name: ‚è≠Ô∏è Skip n8n notify (no secrets)
        if: ${{ always() && (env.N8N_WEBHOOK_URL == '' || env.N8N_WEBHOOK_SECRET == '') }}
        run: |
          echo "n8n webhook skipped: secrets not configured"

      - name: üì£ Notify n8n webhook (health check)
        if: ${{ always() && env.N8N_WEBHOOK_URL != '' && env.N8N_WEBHOOK_SECRET != '' }}
        run: |
          set -euo pipefail
          
          ts="$(date -u +%FT%TZ)"
          cat > payload.json <<JSON
          {
            "event": "health_check",
            "status": "${{ needs.health-check.result }}",
            "environment": "${{ needs.preflight.outputs.target_environment }}",
            "app_url": "${{ env.APP_URL }}",
            "run_id": "${{ github.run_id }}",
            "run_attempt": "${{ github.run_attempt }}",
            "timestamp": "${ts}"
          }
          JSON
          sig="$(openssl dgst -sha256 -hmac "$N8N_WEBHOOK_SECRET" -binary payload.json | base64)"
          curl -fsS --retry 5 --retry-all-errors --max-time 20 \
            -H "Content-Type: application/json" \
            -H "X-Idempotency-Key: ${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-health" \
            -H "X-Signature-256: sha256=${sig}" \
            --data-binary @payload.json \
            "$N8N_WEBHOOK_URL"

      - name: ‚è≠Ô∏è Skip n8n health notify (no secrets)
        if: ${{ always() && (env.N8N_WEBHOOK_URL == '' || env.N8N_WEBHOOK_SECRET == '') }}
        run: |
          echo "n8n webhook health notification skipped: secrets not configured"

  # üè• Post-Deployment Health Check
  health-check:
    name: üè• Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [preflight, deploy]
    if: needs.preflight.outputs.should_deploy == 'true'
    timeout-minutes: 10
    permissions:
      contents: read
    env:
      N8N_WEBHOOK_URL: ""
      N8N_WEBHOOK_SECRET: ""
    
    steps:
      - name: Guard optional secrets (warn only)
        shell: bash
        run: |
          echo "::warning::n8n webhook secrets not available in environment-protected job"
          echo "::warning::n8n webhook notifications will be skipped"

      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üè• Run health checks
        run: |
          # Wait for deployment to settle
          sleep 30
          
          # Run health checks
          if [[ "${{ needs.preflight.outputs.target_environment }}" == "staging" ]]; then
            HEALTH_URL="${{ env.STAGING_HEALTH_CHECK_URL }}"
          else
            HEALTH_URL="${{ env.PRODUCTION_HEALTH_CHECK_URL }}"
          fi
          
          if [[ -n "$HEALTH_URL" ]]; then
            echo "üè• Running health check on: $HEALTH_URL"
            curl -f "$HEALTH_URL" || exit 1
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è No health check URL configured"
          fi

      - name: ‚è≠Ô∏è Skip n8n webhook (environment protected)
        run: |
          echo "n8n webhook notifications handled in separate job"

  # üìä Deployment Summary
  summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs: [preflight, quality-assurance, build, deploy, health-check, n8n-notifications]
    if: always()
    timeout-minutes: 5
    permissions:
      contents: read
    
    steps:
      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: üìä Generate deployment summary
        run: |
          echo "üöÄ TMS Autonomous Deployment Summary"
          echo "=================================="
          echo ""
          echo "üìÖ Deployment Time: $(date)"
          echo "üîó Repository: ${{ github.repository }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Triggered by: ${{ github.actor }}"
          echo ""
          echo "üéØ Target Environment: ${{ needs.preflight.outputs.target_environment }}"
          echo ""
          echo "üìã Job Results:"
          echo "  üîç Pre-flight: ${{ needs.preflight.result }}"
          echo "  üß™ Quality Assurance: ${{ needs.quality-assurance.result }}"
          echo "  üèóÔ∏è Build: ${{ needs.build.result }}"
          echo "  üöÄ Deployment: ${{ needs.deploy.result }}"
          echo "  üè• Health Check: ${{ needs.health-check.result }}"
          echo ""
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ Deployment completed successfully!"
            if [[ "${{ needs.preflight.outputs.target_environment }}" == "staging" ]]; then
              echo "üåê Staging URL: ${{ env.STAGING_URL }}"
            else
              echo "üåê Production URL: ${{ env.PRODUCTION_URL }}"
            fi
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi

      - name: üßæ Rich Job Summary
        if: ${{ always() }}
        run: |
          {
            echo "## üöÄ TMS Autonomous Deployment Summary"
            echo ""
            echo "- **Ref**: \`${{ github.ref_name }}\`"
            echo "- **Commit**: \`${{ github.sha }}\`"
            echo "- **Environment**: \`${{ needs.preflight.outputs.target_environment }}\`"
            echo "- **App URL**: ${{ env.APP_URL }}"
            echo "- **Decision**: \`${{ needs.preflight.outputs.should_deploy }}\`"
            echo "- **Status**: \`${{ job.status }}\`"
            echo ""
            echo "### üìã Job Results"
            echo "- üîç Pre-flight: \`${{ needs.preflight.result }}\`"
            echo "- üß™ Quality Assurance: \`${{ needs.quality-assurance.result }}\`"
            echo "- üèóÔ∏è Build: \`${{ needs.build.result }}\`"
            echo "- üöÄ Deployment: \`${{ needs.deploy.result }}\`"
            echo "- üè• Health Check: \`${{ needs.health-check.result }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: üí° Local Development Tip
        if: ${{ always() }}
        run: |
          echo "üí° For local testing, use:"
          echo "   act push -P ubuntu-latest=catthehacker/ubuntu:act-latest"
          echo "   act workflow_dispatch -e .github/workflows/autonomous-ci-cd.yml"
